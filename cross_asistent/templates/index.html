{% extends 'widget.html' %}
{% load static filtros %}
{% block title %}Inicio | Bienvenidos ðŸ¦…{% endblock %}
{% block extra_head %}
<link href="{% static 'css/animate.css' %}" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'css/swiper-bundle.min.css' %}" />
<script type="module" src="{% static 'js/model-viewer.min.js' %}"></script>
{% endblock %} {% block link_end-extra %}
<button
    type="button"
    class="btn btn_detail btn-floating m-1 my-lg-0 d-none d-lg-block"
    data-mdb-ripple-init
    data-mdb-modal-init
    data-mdb-target="#modalqr"
>
    <i class="fa-solid fa-mobile-screen-button"></i>
</button>
{% endblock %}
{% block content %}
<main class="main_anchor">
    <!-- Carrousel -->
    <div class="swiper-container" id="top">
        <div class="swiper-wrapper">
            {% for banner in banners %}
            <div class="swiper-slide">
                {% with imagen_url=banner.imagen.url|eliminar_prefijo:'cross_asistent/' %}
                <div class="slide-inner" style="background-image: url({{imagen_url}});">
                    {% endwith %}
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="header-text">
                                    <h2>{% autoescape off %} {{ banner.titulo }} {% endautoescape %}</h2>
                                    <!-- <div class="div-dec"></div> -->
                                    <p>{% autoescape off %} {{ banner.descripcion }} {% endautoescape %}</p>
                                    <div class="buttons">
                                        {% if banner.articulo %}
                                        <a href="{{banner.articulo}}" class="btn_slide btn btn_detail btn-lg">
                                            Ver mÃ¡s <i class="fa-solid fa-up-right-from-square ms-1"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="swiper_buttons_nav">
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
    </div>
    <!-- Asistente -->
    <section href="#asistente" class="asistent_group">
        <div class="box_asistent">
            <model-viewer
                id="asistent_model"
                src="{% static 'models/RobotExpressive.glb' %}"
                tone-mapping="neutral"
                camera-orbit="15deg 70deg 60m"
                poster="{% static 'img/poster.webp' %}"
                shadow-intensity="1"
                >
                <!-- autoplay
                animation-name="Wave" -->
            </model-viewer>
            <div class="box_asistent_controls">
                <div class="controls_buttons">
                    <button type="button" class="btn btn_controls btn_secondary controls_btn_keyboard toggle_controls">
                        <i class="fa-regular fa-keyboard"></i>
                    </button>
                    <button type="button" class="btn btn_controls btn_secondary controls_btn_microphone">
                        <i class="fa-solid fa-comment" id="btn_controls_icon"></i>
                    </button>
                    <button type="button" class="btn btn_controls btn_secondary controls_btn_close">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>
            <form id="chatForm" class="controls_input" method="POST" action="{% url 'chatbot' %}">
                {% csrf_token %}
                <div class="position-relative bottom-0 end-0">
                    <div class="form-outline" data-mdb-input-init>
                        <textarea class="form-control bg-body-tertiary" id="question" name="question" required maxlength="200"></textarea>
                        <label class="form-label bg-body-tertiary" for="question">Haz una pregunta:</label>
                    </div>
                    <div class="controls_input-buttons position-absolute top-0 end-0">
                        <button type="button" id="closeChat" class="btn btn_secondary btn-floating btn-sm controls_btn_close">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <button type="button" id="closeInput" class="btn btn_secondary btn-floating btn-sm toggle_controls">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                        <button type="submit" id="chatForm_submit" class="btn btn_detail btn-floating">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </form>
            <div class="output_messages" id="output"></div>
        </div>
    </section>
</main>

<!-- Modal -->
<div class="modal fade" id="modalqr" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
            <div class="modal-header">
                <h2 class="modal-title" id="exampleModalLabel">Escanea el codigo QR</h2>
                <button
                    type="button"
                    class="btn-close"
                    data-mdb-ripple-init
                    data-mdb-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <img src="{% static 'img/qr_2.png' %}" alt="qr" class="img-fluid" />
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_end %}
    <script src="{% static 'js/owl-carousel.min.js' %}"></script>
    <script src="{% static 'js/swiper.min.js' %}"></script>
    <script src="{% static 'js/custom.js' %}"></script>

    <script>
        document.getElementById('question').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    const cursorPos = this.selectionStart;
                    const textBefore = this.value.substring(0, cursorPos);
                    const textAfter = this.value.substring(cursorPos);
                    this.value = textBefore + "\n" + textAfter;
                    this.selectionStart = cursorPos + 1;
                    this.selectionEnd = cursorPos + 1;
                    event.preventDefault();
                } else {
                    event.preventDefault();
                    document.getElementById('chatForm_submit').click();
                }
            }
        });

        var output = document.getElementById('output');

        document.getElementById('chatForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const pregunta = document.getElementById('question').value;
            const chatForm = e.target;

            fetch(chatForm.action, {
                method: 'POST',
                body: JSON.stringify({ question: pregunta }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': chatForm.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Error desconocido');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    var tokendid = generarCadenaAleatoria(5);
                    const valID = `uuid${tokendid}`;

                    const htmlBlock = `
                        <div class="output_block">
                            <div class="btn_secondary chat_msg user_submit" data-tokeid="${valID}">
                                ${pregunta}
                            </div>
                        </div>
                        <div class="btn_detail chat_msg asistent_response" data-tokeid="${valID}">
                            <span>${data.answer}</span>
                        </div>
                    `;

                    output.insertAdjacentHTML('beforeend', htmlBlock);
                    this.reset();

                    const user_submit = document.querySelector(`.user_submit[data-tokeid="${valID}"]`);
                    const asistent_response = document.querySelector(`.asistent_response[data-tokeid="${valID}"]`);

                    setTimeout(function() {
                        user_submit.classList.add('visible');
                        setTimeout(scrollToBottom, 500);
                        setTimeout(function() {
                            asistent_response.classList.add('visible');
                            setTimeout(scrollToBottom, 350);
                        }, 950);
                    }, 50);

                    
                } else {
                    alertSToast('top', 8000, 'error', `Error: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('ðŸ˜¥ Error:', error);
                alertSToast('top', 8000, 'warning', 'OcurriÃ³ un error. Intente nuevamente. ðŸ˜¥');
            });
        });

        function scrollToBottom() {
            output.scrollTop = output.scrollHeight;
        }

        document.addEventListener("DOMContentLoaded", function() {
            scrollToBottom();
        });

        var observer = new MutationObserver(function() {
            scrollToBottom();
        });

        observer.observe(output, { childList: true, subtree: true });
    </script>
{% endblock %}
